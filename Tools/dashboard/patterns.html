<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Patterns — Chief of Staff</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="app" id="app">
    <nav class="sidebar" id="sidebar"></nav>

    <main class="main" id="main-content">
      <div class="page-header">
        <div>
          <h2>Patterns</h2>
          <div class="subtitle">Session patterns and CLAUDE.md suggestions</div>
        </div>
      </div>

      <div class="stats-row" id="stats-row">
        <div class="stat-card">
          <div class="stat-value" id="stat-total-patterns">-</div>
          <div class="stat-label">Total Patterns</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-with-suggestions">-</div>
          <div class="stat-label">With Suggestions</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-projects-with-patterns">-</div>
          <div class="stat-label">Projects</div>
        </div>
      </div>

      <div id="patterns-content">
        <div class="loading">Loading patterns...</div>
      </div>
    </main>
  </div>

  <!-- Slide-over Panel -->
  <div class="slide-over-backdrop" id="slide-over-backdrop">
    <div class="slide-over">
      <div class="slide-over-header">
        <h3>Pattern</h3>
        <button class="slide-over-close" id="slide-over-close">&times;</button>
      </div>
      <div class="slide-over-meta"></div>
      <div class="slide-over-body"></div>
    </div>
  </div>

  <script src="js/app.js"></script>
  <script>
    /* ─── Patterns Page Logic ─────────────────────────
       SECURITY NOTE: All content rendered on this page comes
       exclusively from the user's own local filesystem (session-patterns
       markdown files in ~/Documents/Projects/). There is no server,
       no external data input, and no untrusted content. innerHTML usage
       with renderMarkdown() processes only trusted local files.
       ──────────────────────────────────────────────── */

    async function onConnected() {
      await loadPatternsPage();
    }

    async function loadPatternsPage() {
      const container = document.getElementById('patterns-content');
      container.textContent = '';

      const allPatterns = await loadAllPatterns();

      // Stats
      const withSuggestions = allPatterns.filter(p => p.hasSuggestions);
      const projectsSet = new Set(allPatterns.map(p => p.projectName));

      document.getElementById('stat-total-patterns').textContent = allPatterns.length;
      document.getElementById('stat-with-suggestions').textContent = withSuggestions.length;
      document.getElementById('stat-projects-with-patterns').textContent = projectsSet.size;

      // Update sidebar dot
      state.pendingSuggestionCount = withSuggestions.length;
      buildSidebar('');

      if (allPatterns.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'empty-state';
        const p = document.createElement('p');
        p.textContent = 'No session patterns found across any projects.';
        empty.appendChild(p);
        container.appendChild(empty);
        return;
      }

      // Section 1: Pending Suggestions
      if (withSuggestions.length > 0) {
        renderSuggestionsSection(container, withSuggestions);
      }

      // Project filter pills
      renderProjectFilterPills(container, allPatterns);

      // Section 2: All Patterns
      renderAllPatternsSection(container, allPatterns);
    }

    // ─── Pending Suggestions Section ──────────────────

    function renderSuggestionsSection(container, patternsWithSuggestions) {
      const section = document.createElement('div');
      section.className = 'section';

      const header = document.createElement('div');
      header.className = 'section-header';
      const h3 = document.createElement('h3');
      h3.textContent = 'Pending Suggestions';
      const badge = document.createElement('span');
      badge.className = 'pattern-suggestion-count';
      badge.textContent = patternsWithSuggestions.length;
      h3.appendChild(document.createTextNode(' '));
      h3.appendChild(badge);
      header.appendChild(h3);
      section.appendChild(header);

      const body = document.createElement('div');
      body.className = 'section-body';

      // Group by project
      const grouped = groupByProject(patternsWithSuggestions);

      for (const [projectName, patterns] of Object.entries(grouped)) {
        const group = document.createElement('div');
        group.className = 'patterns-project-group';

        const groupHeader = document.createElement('div');
        groupHeader.className = 'patterns-project-group-header';
        const h4 = document.createElement('h4');
        h4.textContent = projectName;
        groupHeader.appendChild(h4);
        const countBadge = document.createElement('span');
        countBadge.className = 'count-badge';
        countBadge.textContent = patterns.length;
        groupHeader.appendChild(countBadge);
        group.appendChild(groupHeader);

        for (const pattern of patterns) {
          const entry = createPatternEntry(pattern, true);
          group.appendChild(entry);
        }

        body.appendChild(group);
      }

      section.appendChild(body);
      container.appendChild(section);
    }

    // ─── Project Filter Pills ───────────────────────────

    let activeProjectFilter = null; // null = show all

    function renderProjectFilterPills(container, allPatterns) {
      const projects = [...new Set(allPatterns.map(p => p.projectName))].sort();
      if (projects.length < 2) return;

      const row = document.createElement('div');
      row.className = 'filter-pills';
      row.id = 'project-filter-pills';

      const allPill = document.createElement('button');
      allPill.className = 'filter-pill active';
      allPill.textContent = 'All';
      allPill.addEventListener('click', () => setProjectFilter(null));
      row.appendChild(allPill);

      for (const name of projects) {
        const count = allPatterns.filter(p => p.projectName === name).length;
        const pill = document.createElement('button');
        pill.className = 'filter-pill';
        pill.dataset.project = name;
        pill.textContent = name + ' (' + count + ')';
        pill.addEventListener('click', () => setProjectFilter(name));
        row.appendChild(pill);
      }

      container.appendChild(row);
    }

    function setProjectFilter(projectName) {
      activeProjectFilter = projectName;

      // Update pill active states
      const pills = document.querySelectorAll('#project-filter-pills .filter-pill');
      for (const pill of pills) {
        if (projectName === null) {
          pill.classList.toggle('active', !pill.dataset.project);
        } else {
          pill.classList.toggle('active', pill.dataset.project === projectName);
        }
      }

      // Show/hide project groups
      const groups = document.querySelectorAll('.patterns-project-group');
      for (const group of groups) {
        const header = group.querySelector('.patterns-project-group-header h4');
        if (!header) continue;
        if (projectName === null) {
          group.style.display = '';
        } else {
          group.style.display = header.textContent === projectName ? '' : 'none';
        }
      }
    }

    // ─── All Patterns Section ─────────────────────────

    function renderAllPatternsSection(container, allPatterns) {
      const section = document.createElement('div');
      section.className = 'section';

      const header = document.createElement('div');
      header.className = 'section-header';
      const h3 = document.createElement('h3');
      h3.textContent = 'All Patterns';
      const badge = document.createElement('span');
      badge.className = 'count-badge';
      badge.textContent = allPatterns.length;
      h3.appendChild(document.createTextNode(' '));
      h3.appendChild(badge);
      header.appendChild(h3);

      /* No expand-all button — patterns open in slide-over */

      section.appendChild(header);

      const body = document.createElement('div');
      body.className = 'section-body';

      // Search
      if (allPatterns.length > 3) {
        const searchBar = document.createElement('div');
        searchBar.className = 'search-bar';
        const searchIcon = document.createElement('span');
        searchIcon.className = 'search-icon';
        searchIcon.textContent = '\uD83D\uDD0D';
        searchBar.appendChild(searchIcon);
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.placeholder = 'Search patterns... (press / to focus)';
        searchInput.addEventListener('input', () => {
          const entries = body.querySelectorAll('.log-entry');
          const query = searchInput.value.toLowerCase();
          for (const entry of entries) {
            if (!query) { entry.style.display = ''; continue; }
            const matchTitle = (entry.dataset.title || '').includes(query);
            const matchContent = (entry.dataset.content || '').includes(query);
            entry.style.display = (matchTitle || matchContent) ? '' : 'none';
          }
        });
        searchBar.appendChild(searchInput);
        body.appendChild(searchBar);
      }

      // Group by project
      const grouped = groupByProject(allPatterns);

      for (const [projectName, patterns] of Object.entries(grouped)) {
        const group = document.createElement('div');
        group.className = 'patterns-project-group';

        const groupHeader = document.createElement('div');
        groupHeader.className = 'patterns-project-group-header';
        const h4 = document.createElement('h4');
        h4.textContent = projectName;
        groupHeader.appendChild(h4);
        const countBadge = document.createElement('span');
        countBadge.className = 'count-badge';
        countBadge.textContent = patterns.length;
        groupHeader.appendChild(countBadge);
        group.appendChild(groupHeader);

        for (const pattern of patterns) {
          const entry = createPatternEntry(pattern, false);
          group.appendChild(entry);
        }

        body.appendChild(group);
      }

      section.appendChild(body);
      container.appendChild(section);
    }

    // ─── Helpers ──────────────────────────────────────

    function groupByProject(patterns) {
      const groups = {};
      for (const p of patterns) {
        if (!groups[p.projectName]) groups[p.projectName] = [];
        groups[p.projectName].push(p);
      }
      return groups;
    }

    function createPatternEntry(pattern, showSuggestionsExpanded) {
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.dataset.title = pattern.title.toLowerCase();
      entry.dataset.content = pattern.content.toLowerCase().slice(0, 500);

      const entryHeader = document.createElement('div');
      entryHeader.className = 'log-entry-header';

      // Click opens slide-over
      entryHeader.addEventListener('click', () => {
        openSlideOver(pattern.title, pattern.content);
      });

      const dateEl = document.createElement('span');
      dateEl.className = 'log-entry-date';
      dateEl.textContent = formatDisplayDate(pattern.date);
      entryHeader.appendChild(dateEl);

      const titleEl = document.createElement('span');
      titleEl.className = 'log-entry-title';
      titleEl.textContent = pattern.title;
      entryHeader.appendChild(titleEl);

      // Suggestion badges in header (visual indicator before clicking)
      if (pattern.hasSuggestions) {
        const badgeWrap = document.createElement('span');
        badgeWrap.className = 'pattern-entry-suggestions';
        for (const s of pattern.suggestions) {
          const typeBadge = document.createElement('span');
          typeBadge.className = 'suggestion-type-badge type-' + s.type;
          typeBadge.textContent = s.type;
          badgeWrap.appendChild(typeBadge);
        }
        entryHeader.appendChild(badgeWrap);
      }

      entry.appendChild(entryHeader);
      return entry;
    }

    // ─── Slide-over close ──────────────────────────
    document.getElementById('slide-over-close').addEventListener('click', closeSlideOver);
    document.getElementById('slide-over-backdrop').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeSlideOver();
    });

    // ─── Boot ─────────────────────────────────────────

    (async function boot() {
      const connected = await initApp();
      if (connected) {
        buildSidebar('');
        await loadPatternsPage();
      }
    })();
  </script>
</body>
</html>
