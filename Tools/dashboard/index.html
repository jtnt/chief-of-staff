<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chief of Staff</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="app" id="app">
    <nav class="sidebar" id="sidebar"></nav>

    <main class="main" id="main-content">
      <div class="page-header">
        <div>
          <h2>Home</h2>
          <div class="subtitle">Cross-project tasks, stats, and recent activity</div>
        </div>
      </div>

      <div id="health-alert-strip"></div>

      <div class="home-grid">
        <div class="inbox-column" id="inbox-column">
          <div class="loading">Loading inbox...</div>
        </div>
        <div class="activity-column" id="activity-column">
          <div class="loading">Loading activity...</div>
        </div>
      </div>
    </main>
  </div>

  <!-- Task Detail Slide-over -->
  <div class="slide-over-backdrop" id="slide-over-backdrop">
    <div class="slide-over">
      <div class="slide-over-header">
        <h3>Task</h3>
        <button class="slide-over-close" id="slide-over-close">&times;</button>
      </div>
      <div class="slide-over-meta"></div>
      <div class="slide-over-body"></div>
    </div>
  </div>

  <script src="js/app.js"></script>
  <script>
    // ─── Home Page Logic ─────────────────────────────

    const COS_INBOX_PATH = 'Chief of Staff/project-knowledge.md';

    async function onConnected() {
      await loadHomePage();
    }

    // Reload tasks when a checkbox is toggled (item may have moved to Done)
    function onCheckboxToggled() {
      loadCrossProjectTasks();
    }

    async function loadHomePage() {
      await Promise.all([
        loadCrossProjectTasks(),
        loadRecentActivity(),
      ]);
      // Run health scan in background (non-blocking)
      scanHealthAlerts().then(() => {
        renderAlertStrip();
        buildSidebar('');
      });
    }

    function renderAlertStrip() {
      const container = document.getElementById('health-alert-strip');
      if (!container) return;
      container.textContent = '';

      const alerts = state.healthAlerts;
      if (!alerts || alerts.length === 0) return;

      const strip = document.createElement('div');
      strip.className = 'alert-strip' + (state.healthDotLevel === 'amber' ? ' warn-level' : '');

      const text = document.createElement('div');
      text.className = 'alert-strip-text';

      const count = alerts.length;
      const topIssues = alerts.slice(0, 2)
        .map(a => a.project + ': ' + a.issues.join(', '))
        .join('  \u00B7  ');

      const link = document.createElement('a');
      link.href = 'health.html';
      link.textContent = count + ' project' + (count !== 1 ? 's' : '') + ' need attention';
      text.appendChild(link);

      const detail = document.createElement('span');
      detail.style.cssText = 'margin-left: 8px; opacity: 0.8;';
      detail.textContent = '\u2014 ' + topIssues;
      text.appendChild(detail);

      strip.appendChild(text);

      const dismiss = document.createElement('button');
      dismiss.className = 'alert-strip-dismiss';
      dismiss.textContent = '\u00D7';
      dismiss.title = 'Dismiss';
      dismiss.addEventListener('click', (e) => {
        e.preventDefault();
        strip.remove();
      });
      strip.appendChild(dismiss);

      container.appendChild(strip);
    }

    // ─── Cross-Project Tasks ─────────────────────────

    async function loadCrossProjectTasks() {
      const column = document.getElementById('inbox-column');
      column.textContent = '';

      const tasks = await loadAllTasks(50);

      if (tasks.length === 0) {
        const empty = document.createElement('div');
        empty.style.cssText = 'color: var(--text-muted); font-size: 0.85rem; font-style: italic; padding: 12px 0;';
        empty.textContent = 'No pending tasks found across projects';
        const wrapper = document.createElement('div');
        wrapper.className = 'section';
        const wrapperHeader = document.createElement('div');
        wrapperHeader.className = 'section-header';
        const wrapperH3 = document.createElement('h3');
        wrapperH3.textContent = 'Tasks';
        wrapperHeader.appendChild(wrapperH3);
        wrapper.appendChild(wrapperHeader);
        const wrapperBody = document.createElement('div');
        wrapperBody.className = 'section-body';
        wrapperBody.appendChild(empty);
        wrapper.appendChild(wrapperBody);
        column.appendChild(wrapper);
        return;
      }

      // Group tasks by project
      const byProject = new Map();
      for (const task of tasks) {
        if (!byProject.has(task.projectName)) {
          byProject.set(task.projectName, []);
        }
        byProject.get(task.projectName).push(task);
      }

      // Render each project as a collapsible section
      for (const [projectName, projectTasks] of byProject) {
        const section = document.createElement('div');
        section.className = 'section project-task-group';

        const header = document.createElement('div');
        header.className = 'section-header project-group-header';
        header.style.cursor = 'pointer';

        const chevron = document.createElement('span');
        chevron.className = 'project-group-chevron';
        chevron.textContent = '\u25BE';
        header.appendChild(chevron);

        const h3 = document.createElement('h3');
        h3.textContent = projectName;
        header.appendChild(h3);

        const badge = document.createElement('span');
        badge.className = 'count-badge';
        badge.textContent = projectTasks.length;
        header.appendChild(badge);

        section.appendChild(header);

        const body = document.createElement('div');
        body.className = 'section-body project-group-body';

        for (const task of projectTasks) {
          body.appendChild(createTaskItemEl(task.item, task.filePath, task.sectionName));
        }

        section.appendChild(body);
        column.appendChild(section);

        // Collapse/expand on header click
        header.addEventListener('click', () => {
          section.classList.toggle('collapsed');
        });
      }

      // Quick-add input scoped to CoS Inbox
      const addSection = document.createElement('div');
      addSection.className = 'section';
      const addBody = document.createElement('div');
      addBody.className = 'section-body';
      const addRow = document.createElement('div');
      addRow.className = 'add-task-row';
      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'Add task to CoS Inbox... (Title \u2014 context)';
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && input.value.trim()) {
          addNewTask('Inbox', input.value.trim());
          input.value = '';
        }
      });
      addRow.appendChild(input);
      addBody.appendChild(addRow);
      addSection.appendChild(addBody);
      column.appendChild(addSection);
    }

    async function addNewTask(sectionName, text) {
      const content = await readFile(state.rootHandle, 'Chief of Staff', 'project-knowledge.md');
      if (!content) return;

      const today = new Date().toISOString().split('T')[0];
      let title = text;
      let context = '';
      const dashIdx = text.indexOf(' \u2014 ');
      if (dashIdx > 0) {
        title = text.slice(0, dashIdx);
        context = text.slice(dashIdx + 3);
      }
      const newLine = context
        ? '- [ ] **' + title + '**\n\t- ' + context + ' `#manual` `' + today + '`'
        : '- [ ] **' + title + '**\n\t- `#manual` `' + today + '`';

      const lines = content.split('\n');
      let insertIdx = -1;

      for (let i = 0; i < lines.length; i++) {
        if (lines[i].match(new RegExp('^#{2,3} ' + escapeRegex(sectionName) + '$'))) {
          insertIdx = i + 1;
          while (insertIdx < lines.length && lines[insertIdx].trim() === '') {
            insertIdx++;
          }
          break;
        }
      }

      if (insertIdx === -1) return;

      lines.splice(insertIdx, 0, newLine);
      const success = await writeFile(state.rootHandle, ['Chief of Staff', 'project-knowledge.md'], lines.join('\n'));
      if (success) {
        await loadCrossProjectTasks();
      }
    }

    // ─── Recent Activity ───────────────────────────

    async function loadRecentActivity() {
      const column = document.getElementById('activity-column');
      column.textContent = '';

      const section = document.createElement('div');
      section.className = 'section';

      const header = document.createElement('div');
      header.className = 'section-header';
      const h3 = document.createElement('h3');
      h3.textContent = 'Recent Activity';
      header.appendChild(h3);
      section.appendChild(header);

      const body = document.createElement('div');
      body.className = 'section-body';

      const loadingEl = document.createElement('div');
      loadingEl.className = 'loading';
      loadingEl.textContent = 'Loading logs...';
      body.appendChild(loadingEl);
      section.appendChild(body);
      column.appendChild(section);

      // Load logs
      const logs = await loadAllRecentLogs(20);

      body.textContent = '';

      if (logs.length === 0) {
        const empty = document.createElement('div');
        empty.style.cssText = 'color: var(--text-muted); font-size: 0.85rem; font-style: italic; padding: 12px 0;';
        empty.textContent = 'No recent sessions found';
        body.appendChild(empty);
        return;
      }

      for (const log of logs) {
        const item = document.createElement('div');
        item.className = 'activity-item';
        item.addEventListener('click', (e) => {
          if (e.target.closest('.resume-btn')) return;
          const projPath = log.projectPath || null;
          openSlideOver(log.title, log.content, log.sessionId, projPath);
        });

        const headerRow = document.createElement('div');
        headerRow.className = 'activity-header';

        const pill = document.createElement('span');
        pill.className = 'activity-project-pill';
        pill.textContent = log.projectName;
        headerRow.appendChild(pill);

        const dateEl = document.createElement('span');
        dateEl.className = 'activity-date';
        dateEl.textContent = formatDisplayDate(log.date);
        headerRow.appendChild(dateEl);

        item.appendChild(headerRow);

        const titleEl = document.createElement('div');
        titleEl.className = 'activity-title';
        titleEl.textContent = log.title;
        item.appendChild(titleEl);

        if (log.preview) {
          const previewEl = document.createElement('div');
          previewEl.className = 'activity-preview';
          previewEl.textContent = log.preview;
          item.appendChild(previewEl);
        }

        if (log.sessionId) {
          const projPath = log.projectPath || null;
          const resumeRow = document.createElement('div');
          resumeRow.className = 'activity-resume';
          resumeRow.appendChild(createResumeBtns(log.sessionId, projPath));
          item.appendChild(resumeRow);
        }

        body.appendChild(item);
      }
    }

    // ─── Slide-over close ──────────────────────────

    document.getElementById('slide-over-close').addEventListener('click', closeSlideOver);

    // ─── Boot ──────────────────────────────────────

    (async function boot() {
      const connected = await initApp();
      if (connected) {
        buildSidebar('');
        await loadHomePage();
      }
    })();
  </script>
</body>
</html>
