<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project — Chief of Staff</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="app" id="app">
    <nav class="sidebar" id="sidebar"></nav>

    <main class="main" id="main-content">
      <div class="project-header" id="project-header">
        <h2 id="project-name">Loading...</h2>
      </div>

      <div class="project-sections" id="project-sections">
        <div class="loading">Loading project data...</div>
      </div>
    </main>
  </div>

  <!-- Task Detail Slide-over -->
  <div class="slide-over-backdrop" id="slide-over-backdrop">
    <div class="slide-over">
      <div class="slide-over-header">
        <h3>Task</h3>
        <button class="slide-over-close" id="slide-over-close">&times;</button>
      </div>
      <div class="slide-over-meta"></div>
      <div class="slide-over-body"></div>
    </div>
  </div>

  <script src="js/app.js"></script>
  <script>
    /* ─── Project Page Logic ──────────────────────────
       SECURITY NOTE: All innerHTML usage in this file renders content
       exclusively from the user's own local filesystem (markdown files
       in ~/Documents/Projects/). There is no server, no external data
       input, and no untrusted content. This is a personal offline tool.
       ──────────────────────────────────────────────── */

    let currentProject = null;

    async function onConnected() {
      await loadProjectPage();
    }

    function onCheckboxToggled() {
      loadProjectPage();
    }

    async function loadProjectPage() {
      const slug = getCurrentSlug();
      if (!slug) {
        window.location.href = 'index.html';
        return;
      }

      currentProject = state.projects.find(p => p.slug === slug);
      if (!currentProject) {
        const sections = document.getElementById('project-sections');
        sections.textContent = '';
        const err = document.createElement('div');
        err.className = 'error-message';
        err.textContent = 'Project not found: ' + slug;
        sections.appendChild(err);
        return;
      }

      // Update page title
      document.title = currentProject.name + ' \u2014 Chief of Staff';

      // Header
      const header = document.getElementById('project-header');
      header.textContent = '';

      const headerLeft = document.createElement('div');

      const h2 = document.createElement('h2');
      h2.textContent = currentProject.name;
      headerLeft.appendChild(h2);

      const badge = document.createElement('span');
      badge.className = 'status-badge status-' + currentProject.status.toLowerCase().replace(/[^a-z]/g, '');
      badge.textContent = currentProject.status;
      headerLeft.appendChild(badge);

      const pathEl = document.createElement('div');
      pathEl.className = 'project-path';
      pathEl.textContent = currentProject.relPath;
      headerLeft.appendChild(pathEl);

      header.appendChild(headerLeft);

      // Load sections
      const container = document.getElementById('project-sections');
      container.textContent = '';

      // Load all data in parallel
      const [knowledgeContent, indexContent, logs, patterns] = await Promise.all([
        readFile(state.rootHandle, ...currentProject.relPath.split('/'), 'project-knowledge.md'),
        readFile(state.rootHandle, 'Chief of Staff', 'project-index.md'),
        loadProjectLogs(currentProject.relPath),
        loadProjectPatterns(currentProject.relPath),
      ]);

      // Two-column grid: Tasks (left) + Recent Activity (right)
      const grid = document.createElement('div');
      grid.className = 'project-grid';

      const leftCol = document.createElement('div');
      leftCol.className = 'project-grid-left';
      renderProjectTasks(leftCol, knowledgeContent);

      const rightCol = document.createElement('div');
      rightCol.className = 'project-grid-right';
      renderProjectActivityColumn(rightCol, logs.slice(0, 5));

      grid.appendChild(leftCol);
      grid.appendChild(rightCol);
      container.appendChild(grid);

      // Below grid: Project Knowledge (collapsible)
      renderProjectKnowledge(container, knowledgeContent, indexContent);

      // Below grid: Session Patterns (collapsible, accordion)
      renderProjectPatterns(container, patterns);

      // Full session logs list (click opens slide-over)
      renderProjectLogs(container, logs);

      // Re-add quick-add bar (header was rebuilt)
      buildQuickAddBar();
    }

    // ─── Activity Column (project mini-dashboard) ──

    function renderProjectActivityColumn(container, logs) {
      const section = document.createElement('div');
      section.className = 'section';

      const header = document.createElement('div');
      header.className = 'section-header';
      const h3 = document.createElement('h3');
      h3.textContent = 'Recent Activity';
      const badge = document.createElement('span');
      badge.className = 'count-badge';
      badge.textContent = logs.length;
      h3.appendChild(document.createTextNode(' '));
      h3.appendChild(badge);
      header.appendChild(h3);
      section.appendChild(header);

      const body = document.createElement('div');
      body.className = 'section-body';

      if (logs.length === 0) {
        const empty = document.createElement('div');
        empty.style.cssText = 'color: var(--text-muted); font-size: 0.85rem; font-style: italic; padding: 8px 0;';
        empty.textContent = 'No recent sessions found';
        body.appendChild(empty);
      } else {
        for (const log of logs) {
          const item = document.createElement('div');
          item.className = 'activity-item';

          // Click to open slide-over (but don't intercept resume button clicks)
          item.addEventListener('click', (e) => {
            if (e.target.closest('.resume-btn')) return;
            openSlideOver(log.title, log.content, log.sessionId);
          });

          const headerRow = document.createElement('div');
          headerRow.className = 'activity-header';

          const dateEl = document.createElement('span');
          dateEl.className = 'activity-date';
          dateEl.textContent = formatDisplayDate(log.date);
          headerRow.appendChild(dateEl);

          item.appendChild(headerRow);

          const titleEl = document.createElement('div');
          titleEl.className = 'activity-title';
          titleEl.textContent = log.title;
          item.appendChild(titleEl);

          if (log.preview) {
            const previewEl = document.createElement('div');
            previewEl.className = 'activity-preview';
            previewEl.textContent = log.preview;
            item.appendChild(previewEl);
          }

          if (log.sessionId) {
            const resumeRow = document.createElement('div');
            resumeRow.className = 'activity-resume';
            resumeRow.appendChild(createResumeBtns(log.sessionId));
            item.appendChild(resumeRow);
          }

          body.appendChild(item);
        }
      }

      section.appendChild(body);
      container.appendChild(section);
    }

    // ─── Section A: Project Tasks ──────────────────

    function renderProjectTasks(container, knowledgeContent) {
      const tasksResult = knowledgeContent ? extractTasksSection(knowledgeContent) : null;

      const section = document.createElement('div');
      section.className = 'section';

      const header = document.createElement('div');
      header.className = 'section-header';
      const h3 = document.createElement('h3');
      h3.textContent = 'Tasks';
      header.appendChild(h3);
      section.appendChild(header);

      const body = document.createElement('div');
      body.className = 'section-body';

      if (!tasksResult) {
        const empty = document.createElement('div');
        empty.style.cssText = 'color: var(--text-muted); font-size: 0.85rem; font-style: italic; padding: 8px 0;';
        empty.textContent = 'No tasks found (add a ## Tasks section to project-knowledge.md)';
        body.appendChild(empty);
      } else {
        const inbox = parseInbox(tasksResult.text, tasksResult.lineOffset);
        const filePath = currentProject.relPath + '/project-knowledge.md';

        for (const sec of inbox.sections) {
          if (sec.items.length === 0) continue;

          const subHeader = document.createElement('div');
          subHeader.style.cssText = 'font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.06em; margin: 12px 0 6px; padding-top: 8px; border-top: 1px solid var(--border);';
          subHeader.textContent = sec.name + ' (' + sec.items.length + ')';
          body.appendChild(subHeader);

          for (const item of sec.items) {
            body.appendChild(createTaskItemEl(item, filePath, sec.name));
          }
        }

        // Archive button for Done items
        const doneSection = inbox.sections.find(s => s.name === 'Done');
        if (doneSection) {
          const checkedCount = doneSection.items.filter(i => i.checked).length;
          if (checkedCount > 0) {
            const archiveBtn = document.createElement('button');
            archiveBtn.className = 'btn btn-ghost btn-sm';
            archiveBtn.style.marginTop = '8px';
            archiveBtn.textContent = 'Archive ' + checkedCount;
            archiveBtn.addEventListener('click', async () => {
              archiveBtn.textContent = 'Archiving...';
              archiveBtn.disabled = true;
              const success = await archiveCompletedItems(filePath);
              if (success) {
                await loadProjectPage();
              } else {
                archiveBtn.textContent = 'Failed';
                setTimeout(() => { archiveBtn.textContent = 'Archive ' + checkedCount; archiveBtn.disabled = false; }, 1500);
              }
            });
            body.appendChild(archiveBtn);
          }
        }

        // Add task input
        const addRow = document.createElement('div');
        addRow.className = 'add-task-row';
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = 'Add task... (Title \u2014 context)';
        input.addEventListener('keydown', async (e) => {
          if (e.key === 'Enter' && input.value.trim()) {
            await addProjectTask(input.value.trim());
            input.value = '';
          }
        });
        addRow.appendChild(input);
        body.appendChild(addRow);

        // Update header badge
        const pendingCount = inbox.sections.reduce((sum, s) => {
          if (s.name === 'Done') return sum;
          return sum + s.items.filter(i => !i.checked).length;
        }, 0);
        if (pendingCount > 0) {
          const countBadge = document.createElement('span');
          countBadge.className = 'count-badge';
          countBadge.textContent = pendingCount;
          h3.appendChild(document.createTextNode(' '));
          h3.appendChild(countBadge);
        }
      }

      section.appendChild(body);
      container.appendChild(section);
    }

    async function addProjectTask(text) {
      const pathParts = currentProject.relPath.split('/').concat('project-knowledge.md');
      const content = await readFile(state.rootHandle, ...pathParts);
      if (!content) return;

      const today = new Date().toISOString().split('T')[0];
      let title = text;
      let context = '';
      const dashIdx = text.indexOf(' \u2014 ');
      if (dashIdx > 0) {
        title = text.slice(0, dashIdx);
        context = text.slice(dashIdx + 3);
      }
      const newLine = context
        ? '- [ ] **' + title + '**\n\t- ' + context + ' `#manual` `' + today + '`'
        : '- [ ] **' + title + '**\n\t- `#manual` `' + today + '`';

      const lines = content.split('\n');
      let insertIdx = -1;

      // Find ## Tasks header and insert after it (or after ### Inbox if it exists)
      for (let i = 0; i < lines.length; i++) {
        if (/^## Tasks$/.test(lines[i])) {
          // Look for ### Inbox first (CoS pattern)
          let found = false;
          for (let j = i + 1; j < lines.length; j++) {
            if (/^### Inbox$/.test(lines[j])) {
              insertIdx = j + 1;
              while (insertIdx < lines.length && lines[insertIdx].trim() === '') insertIdx++;
              found = true;
              break;
            }
            if (/^#{2,3} /.test(lines[j]) && !/^### Inbox/.test(lines[j])) break;
          }
          if (!found) {
            // No subsections — insert right after ## Tasks
            insertIdx = i + 1;
            while (insertIdx < lines.length && lines[insertIdx].trim() === '') insertIdx++;
          }
          break;
        }
      }

      if (insertIdx === -1) return;

      lines.splice(insertIdx, 0, newLine);
      const success = await writeFile(state.rootHandle, pathParts, lines.join('\n'));
      if (success) {
        await loadProjectPage();
      }
    }

    // ─── Section B: Project Knowledge ──────────────

    function renderProjectKnowledge(container, knowledgeContent, indexContent) {
      const section = document.createElement('div');
      section.className = 'section';

      const header = document.createElement('div');
      header.className = 'section-header clickable';

      const h3 = document.createElement('h3');
      h3.textContent = 'Project Knowledge';
      header.appendChild(h3);

      const actions = document.createElement('div');
      actions.className = 'section-header-actions';
      const chevron = document.createElement('span');
      chevron.className = 'section-chevron';
      chevron.textContent = '\u25B8';
      actions.appendChild(chevron);
      header.appendChild(actions);

      header.addEventListener('click', () => {
        const body = section.querySelector('.section-body');
        section.classList.toggle('expanded');
        body.style.display = section.classList.contains('expanded') ? '' : 'none';
      });

      section.appendChild(header);

      const body = document.createElement('div');
      body.className = 'section-body';

      // Strip ## Tasks section from knowledge view (tasks rendered separately above)
      let contentToRender = knowledgeContent;
      if (contentToRender) {
        contentToRender = contentToRender.replace(/\n## Tasks\n[\s\S]*$/, '');
      }
      if (!contentToRender && indexContent) {
        const headingPattern = new RegExp('### ' + escapeRegex(currentProject.name) + '([\\s\\S]*?)(?=\\n---\\n|\\n### |$)', 'i');
        const match = indexContent.match(headingPattern);
        if (match) {
          contentToRender = '# ' + currentProject.name + '\n' + match[1];
        }
      }

      if (contentToRender) {
        const mdDiv = document.createElement('div');
        mdDiv.className = 'markdown-body';
        // renderMarkdown processes user's own local files only
        mdDiv.innerHTML = renderMarkdown(contentToRender);
        body.appendChild(mdDiv);
      } else {
        const empty = document.createElement('div');
        empty.style.cssText = 'color: var(--text-muted); font-size: 0.85rem; font-style: italic; padding: 8px 0;';
        empty.textContent = 'No project-knowledge.md found';
        body.appendChild(empty);
      }

      // Default collapsed (expand on demand)
      body.style.display = 'none';

      section.appendChild(body);
      container.appendChild(section);
    }

    // ─── Section C: Session Logs ───────────────────

    function renderProjectLogs(container, logs) {
      const section = document.createElement('div');
      section.className = 'section';

      const header = document.createElement('div');
      header.className = 'section-header clickable';

      const h3 = document.createElement('h3');
      h3.textContent = 'All Session Logs';

      const badge = document.createElement('span');
      badge.className = 'count-badge';
      badge.textContent = logs.length;
      h3.appendChild(document.createTextNode(' '));
      h3.appendChild(badge);
      header.appendChild(h3);

      const actions = document.createElement('div');
      actions.className = 'section-header-actions';
      const chevron = document.createElement('span');
      chevron.className = 'section-chevron';
      chevron.textContent = '\u25B8';
      actions.appendChild(chevron);
      header.appendChild(actions);

      header.addEventListener('click', () => {
        const body = section.querySelector('.section-body');
        section.classList.toggle('expanded');
        body.style.display = section.classList.contains('expanded') ? '' : 'none';
      });

      section.appendChild(header);

      const body = document.createElement('div');
      body.className = 'section-body';

      // Search
      if (logs.length > 3) {
        const searchBar = document.createElement('div');
        searchBar.className = 'search-bar';

        const searchIcon = document.createElement('span');
        searchIcon.className = 'search-icon';
        searchIcon.textContent = '\uD83D\uDD0D';
        searchBar.appendChild(searchIcon);

        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.placeholder = 'Search logs... (press / to focus)';
        searchInput.addEventListener('input', () => {
          filterLogs(body, searchInput.value.toLowerCase());
        });
        searchBar.appendChild(searchInput);
        body.appendChild(searchBar);
      }

      if (logs.length === 0) {
        const empty = document.createElement('div');
        empty.style.cssText = 'color: var(--text-muted); font-size: 0.85rem; font-style: italic; padding: 8px 0;';
        empty.textContent = 'No session logs found';
        body.appendChild(empty);
      } else {
        for (const log of logs) {
          const entry = document.createElement('div');
          entry.className = 'log-entry';
          entry.dataset.title = log.title.toLowerCase();
          entry.dataset.content = log.content.toLowerCase().slice(0, 500);

          const entryHeader = document.createElement('div');
          entryHeader.className = 'log-entry-header';

          // Click opens slide-over (but don't intercept resume button clicks)
          entryHeader.addEventListener('click', (e) => {
            if (e.target.closest('.resume-btn')) return;
            openSlideOver(log.title, log.content, log.sessionId);
          });

          const dateEl = document.createElement('span');
          dateEl.className = 'log-entry-date';
          dateEl.textContent = formatDisplayDate(log.date);
          entryHeader.appendChild(dateEl);

          const titleEl = document.createElement('span');
          titleEl.className = 'log-entry-title';
          titleEl.textContent = log.title;
          entryHeader.appendChild(titleEl);

          if (log.sessionId) {
            entryHeader.appendChild(createResumeBtns(log.sessionId));
          }

          entry.appendChild(entryHeader);
          body.appendChild(entry);
        }
      }

      // Default collapsed — activity column shows top 5
      body.style.display = 'none';

      section.appendChild(body);
      container.appendChild(section);
    }

    function filterLogs(body, query) {
      const entries = body.querySelectorAll('.log-entry');
      for (const entry of entries) {
        if (!query) {
          entry.style.display = '';
          continue;
        }
        const matchTitle = entry.dataset.title.includes(query);
        const matchContent = entry.dataset.content.includes(query);
        entry.style.display = (matchTitle || matchContent) ? '' : 'none';
      }
    }

    // ─── Section D: Session Patterns ────────────────

    function renderProjectPatterns(container, patterns) {
      const section = document.createElement('div');
      section.className = 'section';

      const header = document.createElement('div');
      header.className = 'section-header clickable';

      const h3 = document.createElement('h3');
      h3.textContent = 'Session Patterns';

      const badge = document.createElement('span');
      badge.className = 'count-badge';
      badge.textContent = patterns.length;
      h3.appendChild(document.createTextNode(' '));
      h3.appendChild(badge);
      header.appendChild(h3);

      const headerActions = document.createElement('div');
      headerActions.className = 'section-header-actions';
      const chevron = document.createElement('span');
      chevron.className = 'section-chevron';
      chevron.textContent = '\u25B8';
      headerActions.appendChild(chevron);
      header.appendChild(headerActions);

      header.addEventListener('click', () => {
        const patBody = section.querySelector('.section-body');
        section.classList.toggle('expanded');
        patBody.style.display = section.classList.contains('expanded') ? '' : 'none';
      });

      section.appendChild(header);

      const body = document.createElement('div');
      body.className = 'section-body';

      if (patterns.length === 0) {
        const empty = document.createElement('div');
        empty.style.cssText = 'color: var(--text-muted); font-size: 0.85rem; font-style: italic; padding: 8px 0;';
        empty.textContent = 'No session patterns found';
        body.appendChild(empty);
      } else {
        // Show patterns with suggestions first
        const withSuggestions = patterns.filter(p => p.hasSuggestions);
        const withoutSuggestions = patterns.filter(p => !p.hasSuggestions);
        const sorted = [...withSuggestions, ...withoutSuggestions];

        for (const pattern of sorted) {
          const entry = document.createElement('div');
          entry.className = 'log-entry';

          const entryHeader = document.createElement('div');
          entryHeader.className = 'log-entry-header';

          // Click opens slide-over
          entryHeader.addEventListener('click', () => {
            openSlideOver(pattern.title, pattern.content);
          });

          const dateEl = document.createElement('span');
          dateEl.className = 'log-entry-date';
          dateEl.textContent = formatDisplayDate(pattern.date);
          entryHeader.appendChild(dateEl);

          const titleEl = document.createElement('span');
          titleEl.className = 'log-entry-title';
          titleEl.textContent = pattern.title;
          entryHeader.appendChild(titleEl);

          // Suggestion badges (visual indicator before clicking)
          if (pattern.hasSuggestions) {
            const badgeWrap = document.createElement('span');
            badgeWrap.className = 'pattern-entry-suggestions';
            for (const s of pattern.suggestions) {
              const typeBadge = document.createElement('span');
              typeBadge.className = 'suggestion-type-badge type-' + s.type;
              typeBadge.textContent = s.type;
              badgeWrap.appendChild(typeBadge);
            }
            entryHeader.appendChild(badgeWrap);
          }

          entry.appendChild(entryHeader);
          body.appendChild(entry);
        }
      }

      // Suggestion count in header
      const sugCount = patterns.filter(p => p.hasSuggestions).length;
      if (sugCount > 0) {
        const sugBadge = document.createElement('span');
        sugBadge.className = 'pattern-suggestion-count';
        sugBadge.textContent = sugCount + ' with suggestions';
        sugBadge.style.marginLeft = '8px';
        h3.appendChild(document.createTextNode(' '));
        h3.appendChild(sugBadge);
      }

      // Default collapsed
      body.style.display = 'none';

      section.appendChild(body);
      container.appendChild(section);
    }

    // ─── Slide-over close ──────────────────────────

    document.getElementById('slide-over-close').addEventListener('click', closeSlideOver);

    // ─── Boot ──────────────────────────────────────

    (async function boot() {
      const connected = await initApp();
      if (connected) {
        const slug = getCurrentSlug();
        buildSidebar(slug);
        await loadProjectPage();
      }
    })();
  </script>
</body>
</html>
